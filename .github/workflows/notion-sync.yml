# ğŸš€ Notion-Supabase ìë™ ë™ê¸°í™” ì›Œí¬í”Œë¡œìš°
name: ğŸ“Š Daily Notion Sync

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 00:00)
    - cron: '0 0 * * *'
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤í›„ 6ì‹œ (UTC 09:00)
    - cron: '0 9 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      sync_type:
        description: 'ë™ê¸°í™” ìœ í˜•'
        required: true
        default: 'today'
        type: choice
        options:
        - today
        - week
        - full

env:
  PYTHON_VERSION: '3.13'

jobs:
  notion-sync:
    name: ğŸ“‹ Notion ë°ì´í„° ë™ê¸°í™”
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ${{ env.PYTHON_VERSION }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install supabase python-dotenv requests
        
    - name: ğŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      run: |
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env.local
        echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env.local
        echo "NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}" >> .env.local
        echo "NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}" >> .env.local
        
    - name: ğŸš€ ìë™ ë™ê¸°í™” ì‹¤í–‰
      run: |
        cd scripts
        python supabase_mcp.py auto-schedule --dry-run=false
        
    - name: ğŸ“Š ë™ê¸°í™” ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        cd scripts
        python supabase_mcp.py sync-report --format=github
        
    - name: ğŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      if: always()
      run: |
        echo "ğŸ¯ ë™ê¸°í™” ì™„ë£Œ ì‹œê°: $(date)"
        echo "ğŸ“Š ì²˜ë¦¬ëœ ë ˆì½”ë“œ ìˆ˜: ${SYNC_COUNT:-0}"
        echo "â±ï¸ ì‹¤í–‰ ì‹œê°„: ${SYNC_DURATION:-unknown}"
        
    - name: ğŸ”” Slack ì•Œë¦¼ (ì‹¤íŒ¨ì‹œ)
      if: failure()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SLACK_MESSAGE: 'âŒ Notion ë™ê¸°í™” ì‹¤íŒ¨: ${{ github.workflow }}'
        SLACK_COLOR: danger
        
    - name: âœ… ì„±ê³µ ì•Œë¦¼
      if: success()
      run: |
        echo "âœ… Notion ë™ê¸°í™” ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ"
        echo "ğŸ“… ì‹¤í–‰ ì¼ì‹œ: $(date)"
